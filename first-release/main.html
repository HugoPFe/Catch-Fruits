<!DOCTYPE html>
<html lang="pt-br">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game</title>

<style>

#screen {
border: 10px solid #CCC;
image-rendering: pixelated;
image-rendering: crisp-edges;
image-rendering: -moz-crisp-edges;
width: 400px; 
height: 400px;
}

</style>

<script src="keyboard-listener.txt"></script>

</head>

<body>
<canvas id="screen" width="10" height="10"> </canvas>

<script>

const screen = window.document.getElementById("screen")
const context = screen.getContext('2d')
const currentPlayerId = 'player1'


function createGame() {
	const state = {
		'players': {},
		'fruits': {}
	}

	function addPlayer(command) {
		const playerId = command.playerId
		const playerX = command.x
		const playerY = command.y

		state.players[playerId] = {
			x: playerX,
			y: playerY
		}
	}

	function removePlayer(command) {
		const playerId = command.playerId

		delete state.players[playerId]
	}

	function addFruit(command) {
		const fruitId = command.fruitId
		const fruitX = command.x
		const fruitY = command.y

		state.fruits[fruitId] = {
			x: fruitX,
			y: fruitY
		}
	}

	function removeFruit(command) {
		const fruitId = command.fruitId

		delete state.fruits[fruitId]
	}

	function movePlayer(command) {
		const acceptedMoves = {
			ArrowUp(player){
				if (player.y > 0) {
					player.y -= 1
				}
			},
			ArrowDown(player){
				if (player.y < screen.height - 1) {
					player.y += 1
				}
			},
			ArrowLeft(player){
				if (player.x > 0) {
					player.x -= 1
				}
			},
			ArrowRight(player){
				if (player.x < screen.width - 1) {
					player.x += 1
				}
			}
		}
		
		const player = state.players[command.playerId]	
		const playerId = command.playerId
		const key = command.key		
		const moveFunction = acceptedMoves[key]
		
		if (player && moveFunction){
			moveFunction(player)
			checkForFruitCollision(playerId)
		}
		

	}

	function checkForFruitCollision(playerId) {
		const player = state.players[playerId]
			
		for (const fruitId in state.fruits) {
			const fruit = state.fruits[fruitId]
			console.log(`Checking ${playerId} and ${fruitId}`)
				
			if (fruit.x === player.x && fruit.y === player.y){
				console.log(`COLLISION between ${playerId} and ${fruitId}`)
				removeFruit({fruitId: fruitId})				
			}
		}
	}	


	return {
		addPlayer,
		removePlayer,
		addFruit,
		removeFruit,
		movePlayer,
		state
	}
}

const game = createGame()
const keyBoardListener = createKeyboardListener()
keyBoardListener.subscribe(game.movePlayer)

game.addPlayer({playerId: 'player1', x: 0, y: 0})
game.addPlayer({playerId: 'player2', x: 0, y: 7})
game.addPlayer({playerId: 'player3', x: 8, y: 0})

game.addFruit({fruitId: 'fruit1', x: 9, y: 9}) 
game.addFruit({fruitId: 'fruit2', x: 2, y: 5}) 

renderScreen()

function renderScreen() {
	context.fillStyle = 'white'
	context.clearRect(0, 0, 10, 10)

	const state = game.state
	
	for (const playerId in state.players) {
		const player = state.players[playerId]
		context.fillStyle = 'black'
		context.fillRect(player.x, player.y, 1, 1)
	}
	
	for (const fruitId in state.fruits) {
		const fruit = state.fruits[fruitId]
		context.fillStyle = 'green'
		context.fillRect(fruit.x, fruit.y, 1, 1)
	}
	
	requestAnimationFrame(renderScreen)
}

</script>

</body>
</html>